/**
* Tencent is pleased to support the open source community by making 蓝鲸智云PaaS平台社区版 (BlueKing PaaS Community Edition) available.
* Copyright (C) 2017-2018 THL A29 Limited, a Tencent company. All rights reserved.
* Licensed under the MIT License (the "License"); you may not use this file except in compliance with the License. You may obtain a copy of the License at
* http://opensource.org/licenses/MIT
* Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions and limitations under the License.
*/
$(function(){function e(){var e;if((e=document.selection)&&e.empty)e.empty();else{window.getSelection&&window.getSelection().removeAllRanges();var t=document.activeElement;if(t){var n=t.nodeName.toLowerCase();("textarea"==n||"input"==n&&"text"==t.type)&&(t.selectionStart=t.selectionEnd)}}}function t(){return{system_name:$("#search_channel_system").val(),channel_path:$("#search_channel_path").val(),channel_name:$("#search_channel_name").val()}}$(".mymodal-backdrop").bind("click",function(){$("body").removeClass("menu-active"),$(".dropdown .dropdown-content").hide()}),$("#search_channel_system").select2();var n={get_selected_channel_ids:function(){var e=[];return $('input[name="channel_id"]:checked').each(function(t,n){e.push($(n).val())}),e}};$("#channels_delete").bind("click",function(){if(channel_ids=n.get_selected_channel_ids(),0===channel_ids.length)return void dialog({id:"bktips",lock:!0,title:'<span style="font-size: 15px;">'+gettext("消息")+"</span>",content:'<i class="bk-icon icon-close2" style="color: red"></i> '+gettext("请先选择待删除的通道！")}).showModal();dialog({title:"<span style='font-size:15px;'>"+gettext("删除确认")+"</span>",width:300,fixed:!0,content:gettext("该操作不可恢复，是否继续？"),ok:function(){$.post(UrlMaker.make("channel_deleted"),{channel_ids:channel_ids.join(",")},function(e){e.error_message?dialog({id:"bktips",fixed:!0,title:"<span style='font-size:15px;'>"+gettext("消息")+"</span>",content:'<i class="bk-icon icon-close2" style="color: red"></i> '+e.error_message}).showModal():(tmp_msg=ngettext("成功删除 %s 个通道！","成功删除 %s 个通道！",e.affected_rows),tmp_msg=interpolate(tmp_msg,[e.affected_rows]),dialog({id:"bktips",fixed:!0,content:'<i class="bk-icon icon-check2" style="color: green"></i>  '+tmp_msg}).show(),setTimeout(function(){window.location.reload()},2e3))})},cancel:function(){},okValue:gettext("确认删除"),cancelValue:gettext("取消")}).showModal()}),Handlebars.registerHelper("channel_edit_url",function(e){return UrlMaker.make("channel_edit",{channel_id:e})});var a=Backbone.Model.extend(),c=new a,o=Backbone.View.extend({el:"body",template:Handlebars.compile($("#tmpl_channel_list").html()),events:{"click #search_channel_btn":function(e){c.set(t())},"click .show_esb_url":function(e){$("body").addClass("menu-active"),$("#"+e.target.id).parent(".dropdown").find(".dropdown-content").show()},"click .copy-to-clipboard":function(t){var n=t.currentTarget,a=$(n).parent().prev(),c=$(n).parent().find(".tooltip-inner");a[0].select();try{document.execCommand("copy"),c.text(gettext("已复制"))}catch(e){c.text(gettext("复制失败，请手动复制"))}e()},'change input[name="channel_id"]':function(e){target=$(e.target),target.is(":checked")?target.parents("tr").addClass("row-selected"):target.parents("tr").removeClass("row-selected")}},initialize:function(){this.listenTo(c,"change",this.render)},render:function(){var e=this.template;$.getJSON(UrlMaker.make("channel_list"),{system_name:c.get("system_name"),channel_path:c.get("channel_path"),channel_name:c.get("channel_name")},function(t){$("#table_channels").html(e(t)),$('[data-toggle="tooltip"]').tooltip()})}});new o;c.set(t()),c.trigger("change")});