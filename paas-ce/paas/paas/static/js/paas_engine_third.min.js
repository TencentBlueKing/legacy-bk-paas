/**
* Tencent is pleased to support the open source community by making 蓝鲸智云PaaS平台社区版 (BlueKing PaaS Community Edition) available.
* Copyright (C) 2017-2018 THL A29 Limited, a Tencent company. All rights reserved.
* Licensed under the MIT License (the "License"); you may not use this file except in compliance with the License. You may obtain a copy of the License at
* http://opensource.org/licenses/MIT
* Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions and limitations under the License.
*/
$(".env_add_btn").on("click",function(){var e=['<tr class="env_record env_edit_status">','<input  type="hidden" class="server_id" disabled value="" />',"    <td>",'       <input class="form-control server_ip"  value="" placeholder="请输入服务器IP"/>',"    </td>","    <td>",'       <input type="number" min="1" max="65535" class="form-control server_port"  value="15672" placeholder="请输入端口"/>',"    </td>","    <td>",'           <input class="form-control username" value="" placeholder="请输入用户名"/>',"    </td>","    <td>",'        <input class="form-control password" value="" placeholder="请输入密码"/>',"    </td>","    <td>",'       <select class="form-control server_cate"  placeholder="请选择服务器类型">','           <option value="rabbitmq">RabbitMQ服务</option>',"       <select>","    </td>","    <td>",'        <span class="server_active">否</span>',"    </td>","    <td>",'    <button type="button" class="btn-info btn-xs env_save_btn">保存</button>','       <button type="button" class="btn-xs env_cancel_btn">取消</button> ','  <a href="###" title="编辑" class="dev_env_opera env_edit_btn"><span aria-hidden="true" class="glyphicon glyphicon-edit"></span></a>','  <a href="###" title="删除" class="dev_env_opera env_del_btn"><span aria-hidden="true" class="glyphicon glyphicon-remove-circle"></span></a>','  <a href="###" title="激活" class="dev_env_opera env_active_btn"><span aria-hidden="true" class="glyphicon glyphicon-saved"></span></a>',"    </td>","</tr>"].join("");return $("#no_record_row").hide(),$("#user_env_table").append($(e)),!1}),$("#user_env_table").on("click",".env_save_btn",function(){var e=($(this),$(this).closest(".env_record")),t=e.find(".server_ip").val(),r=e.find(".server_port").val(),a=e.find(".username").val(),i=e.find(".password").val(),s=e.find(".server_cate").val(),n=e.find(".server_id").val();if(!t)return art.dialog({id:"bktips",width:300,icon:"error",lock:!0,content:"请输入正确的IP地址"}).time(1),e.find(".server_ip").focus(),!1;if(!UTILS.isInt(r)||parseInt(r)<0||parseInt(r)>65535)return art.dialog({id:"bktips",width:300,icon:"error",lock:!0,content:"请输入正确的端口"}).time(1),e.find(".server_port").focus(),!1;if(!a)return art.dialog({id:"bktips",width:300,icon:"error",lock:!0,content:"请输入正确的用户名"}).time(1),e.find(".username").focus(),!1;if(!i)return art.dialog({id:"bktips",width:300,icon:"error",lock:!0,content:"请输入正确的密码"}).time(1),e.find(".password").focus(),!1;if(!s)return art.dialog({id:"bktips",width:300,icon:"error",lock:!0,content:"请选择服务器类型"}).time(1),e.find(".server_cate").focus(),!1;if(n){var d=BLUEKING.config.paas_host()+"engine/external_server/";$.post(d,{server_ip:t,server_port:r,username:a,password:i,server_cate:s,server_id:n},function(t,r){"success"==r?t.result?(art.dialog({id:"bktips",width:300,icon:"succeed",lock:!0,content:"保存成功"}).time(1),e.find("input").attr("disabled","disabled"),e.find("select").attr("disabled","disabled"),e.removeClass("env_edit_status")):art.dialog({id:"bktips",width:300,icon:"error",lock:!0,content:t.message}):art.dialog({id:"bktips",width:300,icon:"error",lock:!0,content:"保存失败"})},"json")}else{var d=BLUEKING.config.paas_host()+"engine/external_server/";$.post(d,{server_ip:t,server_port:r,username:a,password:i,server_cate:s},function(t,r){"success"==r?t.result?(art.dialog({id:"bktips",width:300,icon:"succeed",lock:!0,content:"添加成功"}).time(1),server_data=t.data,e.find(".server_id").val(server_data.server_id),e.find("input").attr("disabled","disabled"),e.find("select").attr("disabled","disabled"),e.removeClass("env_edit_status")):art.dialog({id:"bktips",width:400,icon:"error",lock:!0,content:t.message}):art.dialog({id:"bktips",width:300,icon:"error",lock:!0,content:"添加失败"})},"json")}return!1}),$("#user_env_table").on("click",".env_edit_btn",function(){var e=$(this).closest(".env_record");e.addClass("env_edit_status"),e.find("input").removeAttr("disabled"),e.find("select").removeAttr("disabled");var t=e.find(".server_ip").val(),r=e.find(".server_port").val(),a=e.find(".server_cate").val(),i=e.find(".username").val(),s=e.find(".password").val();return e.attr("data-old-ip",t),e.attr("data-old-port",r),e.attr("data-old-cate",a),e.attr("data-old-username",i),e.attr("data-old-password",s),!1}),$("#user_env_table").on("click",".env_cancel_btn",function(){var e=$(this).closest(".env_record");e.removeClass("env_edit_status"),e.find("input").attr("disabled","disabled"),e.find("select").attr("disabled","disabled");var t=e.attr("data-old-ip"),r=e.attr("data-old-port"),a=e.attr("data-old-cate"),i=e.attr("data-old-username"),s=e.attr("data-old-password");return t||r||a||i||s?(e.find(".server_ip").val(t),e.find(".server_port").val(r),e.find(".server_cate").val(a),e.find(".username").val(i),e.find(".password").val(s)):e.remove(),!1}),$("#user_env_table").on("click",".env_del_btn",function(){var e=$(this).closest(".env_record"),t=e.find(".server_id").val(),r=e.find(".server_ip").val(),a=e.find(".server_port").val(),i=e.find(".server_active").attr("data");if(t){var s=BLUEKING.config.paas_host()+"engine/external_server/"+t+"/",n="<div class='t_s14'>您确定删除该服务器吗?<br>IP : "+r+" , 端口 : "+a+"</div>",d=340;if("1"==i){var d=460;n+="<div style='color:red;margin-top: 10px;font-size: 14px;font-weight: bold;'>该服务器已经激活，删除后应用中的celery任务将不能正常执行<br>请确认不再使用后再删除</div>"}art.dialog({title:"删除确认",width:d,icon:"question",lock:!0,content:n,ok:function(){art.dialog({id:"bktips",width:300,icon:"warning",lock:!0,content:"正在进行删除操作，请稍后..."}),$.ajax({url:s,type:"DELETE",success:function(t){art.dialog({id:"bktips"}).close(),t.result?(art.dialog({id:"bktips",width:300,icon:"succeed",lock:!0,content:t.message}).time(1),e.remove()):art.dialog({id:"bktips",width:300,icon:"error",lock:!0,content:t.message}).time(3)}})},cancel:function(){},okVal:"确认删除",cancelVal:"取消"})}}),$("#user_env_table").on("click",".env_active_btn",function(){var e=$(this).closest(".env_active_btn"),t=$(this).closest(".env_record"),r=t.find(".server_id").val(),a=t.find(".server_ip").val(),i=t.find(".server_port").val();t.find(".server_active").attr("data");if(r){var s=BLUEKING.config.paas_host()+"engine/external_server/active/",n="<div class='t_s14'>正在检测服务器状态，请稍后....<br><br>IP : "+a+" , 端口 : "+i+"</div>";art.dialog({id:"bktips",width:450,height:200,icon:"face-smile",lock:!0,content:n}),$.post(s,{server_id:r},function(r){art.dialog({id:"bktips"}).close(),r.result?(art.dialog({id:"bktips",icon:"succeed",lock:!0,content:r.message}).time(1),t.find(".server_active").attr("data","1"),t.find(".server_active").text("是"),e.removeClass("env_active_btn").addClass("env_refresh_btn").html('<span aria-hidden="true" class="glyphicon  glyphicon-refresh"></span>')):art.dialog({id:"bktips",width:450,height:200,icon:"error",lock:!0,content:r.message})},"json")}}),$("#user_env_table").on("click",".env_refresh_btn",function(){var e=$(this).closest(".env_refresh_btn"),t=$(this).closest(".env_record"),r=t.find(".server_id").val(),a=t.find(".server_ip").val(),i=t.find(".server_port").val();t.find(".server_active").attr("data");if(r){var s=BLUEKING.config.paas_host()+"engine/external_server/refresh/",n="<div class='t_s14'>正在刷新服务器上的agent状态，请稍后....<br><br>IP : "+a+" , Agent端口 : "+i+"</div>";art.dialog({id:"bktips",width:450,height:200,icon:"face-smile",lock:!0,content:n}),$.post(s,{server_id:r},function(r){art.dialog({id:"bktips"}).close(),r.result?(art.dialog({id:"bktips",icon:"succeed",lock:!0,content:r.message}).time(1),t.find(".server_active").attr("data","1"),t.find(".server_active").text("是"),e.removeClass("env_active_btn").addClass("env_refresh_btn").html('<span aria-hidden="true" class="glyphicon  glyphicon-refresh"></span>'),e.attr("title","刷新")):(art.dialog({id:"bktips",width:450,height:200,icon:"error",lock:!0,content:r.message}),t.find(".server_active").attr("data","0"),t.find(".server_active").text("否"),e.removeClass("env_refresh_btn").addClass("env_active_btn").html('<span aria-hidden="true" class="glyphicon glyphicon-saved"></span>'),e.attr("title","激活"))},"json")}});