/**
* Tencent is pleased to support the open source community by making 蓝鲸智云PaaS平台社区版 (BlueKing PaaS Community Edition) available.
* Copyright (C) 2017-2018 THL A29 Limited, a Tencent company. All rights reserved.
* Licensed under the MIT License (the "License"); you may not use this file except in compliance with the License. You may obtain a copy of the License at
* http://opensource.org/licenses/MIT
* Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions and limitations under the License.
*/
function enter_keyword(t){"13"==t.keyCode&&$("#serach_user").click()}function is_user_edit_status(){return $("#user_table_div table tbody tr.user_edit_status").length>0&&(art.dialog({id:"bktips",width:300,icon:"error",lock:!0,content:gettext("不可同时修改多个用户信息，请先保存编辑中的用户信息")}).time(5),!0)}function get_user(t){var e=$("#search_data").val(),r=$("#search_role").val(),a=site_url+"accounts/user/list/query/";$.get(a,{page:t,search_data:e,search_role:r},function(t){$("#user_table_div").html(t)})}$("#search_role").on("onchange",function(){get_user(1)}),$("#serach_user").on("click",function(){get_user(1)}),$(".user_add_btn").on("click",function(){if(is_user_edit_status())return!1;var t=['<tr class="user_record user_edit_status">',"   <td>",'       <input class="form-control u_username" placeholder="'+gettext("请输入用户名")+'"/>',"   </td>","    <td>",'        <input class="form-control u_chname" placeholder="'+gettext("请输入姓名")+'"/>',"   </td>","   <td>",'       <input class="form-control u_phone" placeholder="'+gettext("请输入联系电话")+'"/>',"   </td>","   <td>",'       <input class="form-control u_email" placeholder="'+gettext("请输入邮箱")+'"/>',"   </td>","   <td>",'       <select class="form-control u_role" style="width:90px">','           <option value="0">'+gettext("普通用户")+"</option>",'           <option value="1">'+gettext("管理员")+"</option>",'           <option value="2">'+gettext("开发者")+"</option>",'           <option value="3">'+gettext("职能化")+"</option>",'           <option value="4">'+gettext("审计员")+"</option>","       </select>","   </td>","   <td>",'       <button type="button" class="btn-xs user_cancel_btn">'+gettext("取消")+"</button> ",'       <button type="button" class="btn-info btn-xs user_save_btn">'+gettext("保存")+"</button>",'       <a href="###" title="'+gettext("编辑")+'" class="dev_user_opera user_edit_btn"><span aria-hidden="true" class="glyphicon glyphicon-edit"></span></a>','       <a href="###" title="'+gettext("删除")+'" class="dev_user_opera user_del_btn"><span aria-hidden="true" class="glyphicon glyphicon-remove-circle"></span></a>','      <a href="###" title="'+gettext("重置密码")+'" class="dev_user_opera user_rest_btn"><span aria-hidden="true" class="glyphicon glyphicon-lock"></span></a>',"   </td>","</tr>"].join("");return $("#no_record_row").hide(),$("#user_table").prepend($(t)),!1}),$(".user_export_btn").on("click",function(){window.location.href=site_url+"accounts/user/export/"}),$(".user_import_btn").on("click",function(){$("#data_files").val(""),art.dialog({id:"bktips",title:gettext("批量导入用户"),lock:!0,width:560,content:$("#user_import_div").get(0)}),$("#error_msg").text("")}),$("#user_import_div").on("click",".import_btn",function(){$("#data_files").val()?$("#sumbit_import").click():$("#error_msg").text(gettext("请选择一个文件"))}),$("#user_table_div").on("click",".user_save_btn",function(){var t=($(this),$(this).closest(".user_record")),e=t.attr("user_id"),r=$.trim(t.find(".u_username").val()),a=$.trim(t.find(".u_chname").val()),i=$.trim(t.find(".u_phone").val()),s=$.trim(t.find(".u_email").val()),n=$.trim(t.find(".u_role").val());if(!r.match(/^[A-Za-z0-9][A-Za-z0-9._]{2,18}[A-Za-z0-9]$/))return art.dialog({id:"bktips",width:300,icon:"error",lock:!0,content:gettext("用户名只能包含数字、字母、下划线和点，且长度在4-20个字符, 且必须以字母或数字开头")}),t.find(".u_username").focus(),!1;if(!a.match(/^[\u4e00-\u9fa5a-zA-Z0-9_]{1,16}$/))return art.dialog({id:"bktips",width:300,icon:"error",lock:!0,content:gettext("中文名只能包含数字、字母、中文汉字、下划线，长度在1-16个字符")}),t.find(".u_chname").focus(),!1;if(!i.match(/^\d{10,11}$/))return art.dialog({id:"bktips",width:300,icon:"error",lock:!0,content:gettext("仅支持中国大陆手机号码（11位数字）")}),t.find(".u_phone").focus(),!1;if(!s.match(/^[A-Za-z0-9]+([-_.][A-Za-z0-9]+)*@([A-Za-z0-9]+[-.])+[A-Za-z0-9]{2,5}$/))return art.dialog({id:"bktips",width:300,icon:"error",lock:!0,content:gettext("请输入正确的邮箱格式")}),t.find(".u_email").focus(),!1;if(!n)return art.dialog({id:"bktips",width:300,icon:"error",lock:!0,content:gettext("请选择角色")}),t.find(".u_role").focus(),!1;if(e){var o=site_url+"accounts/user/"+e+"/";$.ajax({url:o,type:"PUT",data:{username:r,chname:a,phone:i,role:n,email:s},success:function(e){if(e.result){art.dialog({id:"bktips",width:300,icon:"succeed",lock:!0,content:gettext("保存成功")}).time(1),t.find("input").attr("disabled","disabled"),t.find("select").attr("disabled","disabled"),t.removeClass("user_edit_status");get_user($("#current_page").val())}else art.dialog({id:"bktips",width:300,icon:"error",lock:!0,content:e.message})},dataType:"json"})}else{var o=site_url+"accounts/user/";$.post(o,{username:r,chname:a,phone:i,role:n,email:s},function(e){e.result?(art.dialog({id:"bktips",width:300,icon:"succeed",lock:!0,content:gettext("添加成功")}).time(1),user_data=e.data,t.attr("user_id",user_data.user_id),t.find("input").attr("disabled","disabled"),t.find("select").attr("disabled","disabled"),t.removeClass("user_edit_status"),get_user(1)):art.dialog({id:"bktips",width:300,icon:"error",lock:!0,content:e.message})},"json")}return!1}),$("#user_table_div").on("click",".user_edit_btn",function(){if(is_user_edit_status())return!1;var t=$(this).closest(".user_record");t.addClass("user_edit_status"),t.find("input").removeAttr("disabled"),t.find(".u_username").attr("disabled","disabled"),t.find("select").removeAttr("disabled");var e=$.trim(t.find(".u_username").val()),r=$.trim(t.find(".u_chname").val()),a=$.trim(t.find(".u_phone").val()),i=$.trim(t.find(".u_role").val()),s=$.trim(t.find(".u_email").val());return t.find(".u_username").attr("placeholder",gettext("请输入用户名")),t.find(".u_chname").attr("placeholder",gettext("请输入中文名")),t.find(".u_phone").attr("placeholder",gettext("请输入手机号")),t.find(".u_email").attr("placeholder",gettext("请输入邮箱")),t.attr("data-old-username",e),t.attr("data-old-chname",r),t.attr("data-old-phone",a),t.attr("data-old-role",i),t.attr("data-old-email",s),!1}),$("#user_table_div").on("click",".user_cancel_btn",function(){var t=$(this).closest(".user_record");t.removeClass("user_edit_status"),t.find("input").attr("disabled","disabled"),t.find("select").attr("disabled","disabled"),t.find(".u_username").attr("placeholder","--"),t.find(".u_chname").attr("placeholder","--"),t.find(".u_phone").attr("placeholder","--"),t.find(".u_email").attr("placeholder","--");var e=t.attr("data-old-username"),r=t.attr("data-old-chname"),a=t.attr("data-old-phone"),i=t.attr("data-old-role"),s=t.attr("data-old-email");return e||r||a||s?(t.find(".u_username").val(e),t.find(".u_chname").val(r),t.find(".u_phone").val(a),t.find(".u_role").val(i),t.find(".u_email").val(s)):t.remove(),0==$("#user_table").find(".user_record").length&&$("#no_record_row").show(),!1}),$("#user_table_div").on("click",".user_del_btn",function(){var t=$(this).closest(".user_record"),e=t.attr("user_id"),r=t.find(".u_username").val();t.find(".u_chname").val();if(e){var a=site_url+"accounts/user/"+e+"/",i="<div class='t_s14'>"+gettext("您确定删除该用户吗?")+"<br>"+gettext("用户名 : ")+r+"</div>";art.dialog({title:gettext("删除确认"),width:340,icon:"question",lock:!0,content:i,ok:function(){art.dialog({id:"bktips",width:300,icon:"warning",lock:!0,content:gettext("正在进行删除操作，请稍后...")}),$.ajax({url:a,type:"DELETE",success:function(e){art.dialog({id:"bktips"}).close(),e.result?(art.dialog({id:"bktips",width:300,icon:"succeed",lock:!0,content:e.message}).time(2),t.remove(),get_user(1)):art.dialog({id:"bktips",width:300,icon:"error",lock:!0,content:e.message})},dataType:"json"})},cancel:function(){},okVal:gettext("确认删除"),cancelVal:gettext("取消")})}}),$("#user_table_div").on("click",".user_rest_btn",function(){$(".error_tip").hide(),$(".password_input").val(""),$("#password_tip").text("");var t=$(this).closest(".user_record"),e=t.attr("user_id");t.find(".u_username").val();art.dialog({id:"bkpwd",title:gettext("重置密码"),lock:!0,width:505,content:$("#change_password_div").get(0),cancelVal:gettext("取消"),cancel:function(){},okVal:gettext("重置密码"),ok:function(){var t=!0;if($(".error_tip").hide(),$("#pattern_tip").css("color","black"),$(".password_input").each(function(){var e=$.trim($(this).val());return e?e.match(/^(?=.*\d)(?=.*[a-z])(?=.*[A-Z])[A-Za-z0-9!@#\$%\^\*\(\)-_\+=]{8,20}$/)||"password1"!=$(this).attr("name")?void 0:($("#pattern_tip").css("color","red"),$(this).focus(),t=!1,!1):($(this).next(".error_tip").show(),$(this).focus(),t=!1,!1)}),!t)return!1;var r=$.trim($("#id_password1").val()),a=$.trim($("#id_password2").val());if(r!=a&&($("#password_tip").text(gettext("两次输入的新密码不一致")),t=!1),!t)return!1;var i=site_url+"accounts/user/"+e+"/password/",s=!0;if($.ajax({url:i,type:"PUT",data:{new_password1:r,new_password2:a},success:function(t){t.result||($("#password_tip").text(t.message),s=!1)},dataType:"json",async:!1}),!s)return!1;art.dialog({width:300,icon:"succeed",lock:!0,content:gettext("密码重置成功")}).time(2)}})});